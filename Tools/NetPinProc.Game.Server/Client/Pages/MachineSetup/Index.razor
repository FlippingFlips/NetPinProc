@page "/machine/setup"
@using BlazorDownloadFile;
@using NetPinProc.Game.Manager.Client.Pages.MachineSetup.MachineItems
@inject NavigationManager Nav
@inject ISnackbar Snack

<PageTitle>Machine Setup | @Names.SITE_NAME</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudGrid Spacing="-20">

        <MudItem xs="12" Class="mb-0">
            <MudToolBar Dense Class="mb-0 mud-theme-primary">
                <MudTooltip Text="@lang["MachineTools:ExportMachineJson"]">
                    <MudIconButton Color="Color.Secondary"
                            Class="mud-theme-error"
                            OnClick="@ExportJsonAsync"
                            Icon="@Icons.Material.Filled.ImportExport"
                            Size="Size.Small" />
                </MudTooltip>                
                <MudTooltip Text="@lang["MachineTools:CheckCompatible"]">
                    <MudIconButton Color="Color.Secondary"
                                   Class="mud-theme-error"
                                   OnClick="@TestMachineConfig"
                                   Icon="@Icons.Material.Filled.AcUnit"
                                   Size="Size.Small" />
                </MudTooltip>
            </MudToolBar>
            </MudItem>

            <MudItem xs="12">
            <MudTabs Outlined="true" Position="Position.Start" Rounded="true" Border="true"
                     MinimumTabWidth="20px"
                     ApplyEffectsToContainer="true" Class="mt-0" PanelClass="pa-1">

                <MudTabPanel Icon="@Icons.Material.Filled.SwitchAccessShortcut">
                    <Switches />
                </MudTabPanel>

                <MudTabPanel Icon="@Icons.Material.Filled.DriveEta">
                    <Drivers />
                </MudTabPanel>

                <MudTabPanel Icon="@Icons.Material.Filled.Lightbulb" ToolTip="Lamps">
                    <Lamps />
                </MudTabPanel>

                <MudTabPanel Icon="@Icons.Material.Filled.LightMode" ToolTip="GI">
                    <GI />
                </MudTabPanel>

                <MudTabPanel Icon="@Icons.Material.Filled.LightbulbCircle" ToolTip="LEDS">
                    <Leds />
                </MudTabPanel>

                <MudTabPanel Icon="@Icons.Material.Filled.Security">
                    <Servos />
                </MudTabPanel>

                <MudTabPanel Icon="@Icons.Material.Filled.DoNotStep">
                    <Steppers />
                </MudTabPanel>
            </MudTabs>
            </MudItem>            
    </MudGrid>
</MudContainer>



@code 
{
    [Inject] HttpClient? Http { get; set; }

    [Inject] IBlazorDownloadFileService? BlazorDownloadFileService { get; set; }

    [Inject] ILanguageContainerService? lang { get; set; }

    async Task ExportJsonAsync()
    {
        try
        {
            var json = await Http.GetStringAsync("api/machine/ExportToJson");

            await BlazorDownloadFileService
                .DownloadFile("machine.json",
                    Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(json)),
                    "application/json");
        }
        catch (Exception ex) { Snack.Add(ex.Message, Severity.Warning); }
    }

    async Task TestMachineConfig()
    {
        try
        {
            var res = await Http.GetAsync("api/machine/IsCompatible");
            if(res.IsSuccessStatusCode)
                Snack.Add($"PROC machine setup passed", Severity.Success);
            else
                Snack.Add($"{await res.Content.ReadAsStringAsync()}", Severity.Warning);
            
        }
        catch (Exception ex) 
        { 
            Snack.Add($"{ex.InnerException?.Message}", Severity.Warning);
        }
    }

    
}